<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Latenz Visualisierung</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        svg {
            width: 100%;
            height: 400px;
        }
        .chart-title {
            font-size: 18px;
            margin: 20px 0 5px;
        }
        .line {
            fill: none;
            stroke-width: 2px;
        }
    </style>
</head>
<body>
    <h2 class="chart-title">Latenz (Rpi -> ESP -> RPi)</h2>
    <svg id="latencyChart"></svg>

    <h2 class="chart-title">Latenz (RPi -> ESP)</h2>
    <svg id="oneWayChart"></svg>

    <script>
        fetch("/data")
            .then(res => res.json())
            .then(data => {
                data.forEach(d => {
                    d.id = +d.id;
                    d.qos = +d.qos;
                    d.latency = +d.latency;
                    d.oneWayLatency = d.latency / 2;
                });

                const qosGroups = d3.group(data, d => d.qos);

                drawLineChart("#latencyChart", qosGroups, "latency", "Latenz (ms)");
                drawLineChart("#oneWayChart", qosGroups, "oneWayLatency", "One-Way Latenz (ms)");
            });

        function drawLineChart(svgId, groups, valueKey, yLabel) {
            const svg = d3.select(svgId);
            svg.selectAll("*").remove();

            const margin = {top: 20, right: 30, bottom: 40, left: 60},
                  width = svg.node().getBoundingClientRect().width - margin.left - margin.right,
                  height = +svg.attr("height") - margin.top - margin.bottom;

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const allData = Array.from(groups.values()).flat();

            const x = d3.scaleLinear()
                .domain(d3.extent(allData, d => d.id))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(allData, d => d[valueKey])])
                .nice()
                .range([height, 0]);

            const color = d3.scaleOrdinal(d3.schemeCategory10).domain(Array.from(groups.keys()));

            const line = d3.line()
                .x(d => x(d.id))
                .y(d => y(d[valueKey]));

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(10).tickFormat(d3.format("d")));

            g.append("g")
                .call(d3.axisLeft(y));

            for (const [qos, values] of groups) {
                g.append("path")
                    .datum(values)
                    .attr("class", "line")
                    .attr("stroke", color(qos))
                    .attr("d", line);

                g.append("text")
                    .datum(values[values.length - 1])
                    .attr("x", d => x(d.id) + 5)
                    .attr("y", d => y(d[valueKey]))
                    .style("fill", color(qos))
                    .style("font-size", "12px")
                    .text(`QoS ${qos}`);
            }

            svg.append("text")
                .attr("x", margin.left)
                .attr("y", 15)
                .text(yLabel)
                .style("font-weight", "bold");
        }
    </script>
</body>
</html>
