<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Latenzvisualisierung</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .chart { margin: 40px; }
        .line { fill: none; stroke-width: 2px; }
        .avg-line { stroke: red; stroke-dasharray: 5 5; }
    </style>
</head>
<body>
    <h1>Latenzvisualisierung</h1>
    <div id="full-rtt" class="chart">
        <h2>Round-Trip Time (RTT)</h2>
        <svg width="900" height="400"></svg>
    </div>
    <div id="one-way" class="chart">
        <h2>One-Way Latenz (RTT / 2)</h2>
        <svg width="900" height="400"></svg>
    </div>

    <script>
        const colors = d3.scaleOrdinal(d3.schemeCategory10);

        d3.json("/api/latency").then(data => {
            const grouped = d3.group(data, d => d.qos);

            // Funktion zum Zeichnen der Diagramme
            function drawChart(containerId, dataTransform) {
                const svg = d3.select(`#${containerId} svg`);
                const margin = {top: 20, right: 30, bottom: 50, left: 60};
                const width = +svg.attr("width") - margin.left - margin.right;
                const height = +svg.attr("height") - margin.top - margin.bottom;
                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleLinear().range([0, width]);
                const y = d3.scaleLinear().range([height, 0]);

                const allData = Array.from(grouped.values()).flat();
                x.domain([0, d3.max(allData, (d, i) => i)]);
                y.domain([0, d3.max(allData, d => dataTransform(d.latency)) * 1.2]);

                g.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).ticks(10).tickFormat(d3.format("d")));

                g.append("g")
                    .call(d3.axisLeft(y));

                Array.from(grouped.entries()).forEach(([qos, values], idx) => {
                    const line = d3.line()
                        .x((d, i) => x(i))
                        .y(d => y(dataTransform(d.latency)));

                    g.append("path")
                        .datum(values)
                        .attr("class", "line")
                        .attr("stroke", colors(qos))
                        .attr("d", line);

                    // Durchschnittslinie
                    const avg = d3.mean(values, d => dataTransform(d.latency));
                    g.append("line")
                        .attr("class", "avg-line")
                        .attr("x1", 0)
                        .attr("x2", width)
                        .attr("y1", y(avg))
                        .attr("y2", y(avg));

                    g.append("text")
                        .attr("x", width - 60)
                        .attr("y", y(avg) - 10)
                        .attr("fill", colors(qos))
                        .text(`QoS ${qos} Ø ${avg.toFixed(1)} ms`);
                });
            }

            drawChart("full-rtt", d => d);
            drawChart("one-way", d => d / 2);
        });
    </script>
</body>
</html>
